éå¸¸æ£’ ğŸ‘ ä½ è¿™æ®µ `RenderEngine` ä»£ç å·²ç»æ˜¯ä¸€ä¸ªå®Œæ•´çš„ã€Œå¯ç¼–ç¨‹æ§åˆ¶ç‰ˆ Cocos å¼•æ“å¯åŠ¨å™¨ã€äº†ã€‚
ä¸è¿‡ä½ é—®çš„å…³é”®ç‚¹æ˜¯â€”â€”

> ğŸ§­ã€Œå¦‚ä½•ç”¨ä»£ç å¯åŠ¨ï¼Ÿæœ¬åœ°å¯åŠ¨å’Œæ‰“åŒ…å¯åŠ¨æœ‰åŒºåˆ«å—ï¼Ÿã€

æˆ‘æ¥å¸®ä½ æ‹†è§£ä½ çš„ `RenderEngine.boot()` æµç¨‹ï¼Œè¯´æ˜å®ƒå…¶å®å·²ç»å‡ ä¹è¦†ç›–äº†ä¸¤ç§æƒ…å†µï¼Œç„¶åæˆ‘ç»™ä½ ä¸€ä¸ªæ›´å¥å£®ã€è‡ªåŠ¨åŒºåˆ†ç¯å¢ƒçš„ä¼˜åŒ–ç‰ˆæœ¬ã€‚

---

## ğŸ§© ä¸€ã€ä½ å½“å‰çš„å¯åŠ¨é€»è¾‘åˆ†æ

ä½ å®šä¹‰çš„å…¥å£å‡½æ•°æ˜¯ï¼š

```ts
async boot(canvasId: string, platform: Platform, cocosUrl: string, isPreview = false)
```

### âœ… æœ¬åœ°é¢„è§ˆï¼ˆç¼–è¾‘å™¨è°ƒè¯•ï¼‰

```ts
if (isPreview) {
  cc.assetManager.init({
    importBase: '/cocos-creator/assets/others/import',
    nativeBase: '/cocos-creator/assets/others/native',
  })
}
```

è¿™æ®µé€»è¾‘æ„å‘³ç€ï¼š

* ä½ å‡å®šæœ¬åœ°è°ƒè¯•æ¨¡å¼ä¸‹èµ„æºæ”¾åœ¨ `/cocos-creator/assets/others/`ï¼›
* ä¸éœ€è¦åŠ è½½ `settings.json`ï¼›
* ç›´æ¥èµ° `loadBaseAsset()` åŠ è½½åŸºç¡€ bundleã€‚

âœ”ï¸ è¿™å°±æ˜¯ â€œåœ¨ Creator ç¼–è¾‘å™¨ä¸­ä»£ç å¯åŠ¨â€ çš„æ–¹å¼ã€‚

---

### âœ… æ‰“åŒ…è¿è¡Œ

```ts
else {
  cc.assetManager.init({})
}
```

è¿™é‡Œä½ åªæ˜¯ç®€å•åˆå§‹åŒ– assetManagerï¼Œç„¶åå†ï¼š

```ts
await this.loadBaseAsset(cocosUrl)
cc.game.run(options, () => {...})
```

ä¹Ÿå°±æ˜¯è¯´ï¼š

* ä½ ä¸ä¾èµ– `settings.json`
* ç›´æ¥é€šè¿‡ `cc.assetManager.loadBundle()` æ‰‹åŠ¨åŠ è½½ `internal` å’Œ `main`
* è‡ªå·±è°ƒç”¨ `cc.game.run()` å¯åŠ¨æ¸¸æˆ
* ç„¶ååŠ¨æ€åˆ›å»ºç©ºåœºæ™¯ï¼ˆ`new cc.Scene()`ï¼‰

è¿™å°±ç›¸å½“äºä½ æ‰‹åŠ¨å®ç°äº† `main.js` å¯åŠ¨æµç¨‹ã€‚

---

## âš ï¸ äºŒã€ç›®å‰çš„é—®é¢˜ / å¯ä¼˜åŒ–ç‚¹

| é—®é¢˜                     | åŸå›                                                     | ä¼˜åŒ–å»ºè®®                                                 |
| ---------------------- | ----------------------------------------------------- | ---------------------------------------------------- |
| âŒ æ²¡æœ‰è‡ªåŠ¨åˆ¤æ–­æ˜¯æœ¬åœ°è¿˜æ˜¯æ‰“åŒ…        | éœ€è¦æ‰‹åŠ¨ä¼  `isPreview`                                     | å¯ä»¥è‡ªåŠ¨æ ¹æ® URL æˆ– `window.location` åˆ¤æ–­                    |
| âŒ æ‰“åŒ…åæ²¡åŠ è½½ settings.json | å¯¼è‡´å¼•æ“é…ç½®ï¼ˆåœºæ™¯ã€åˆ†ç»„ç­‰ï¼‰ä¸¢å¤±                                      | æ‰“åŒ…å¯åŠ¨æ—¶åº”åŠ è½½ `settings.json` å¹¶ `cc.game.run(settings)`   |
| âš ï¸ ä¾èµ–å…¨å±€ `cc`           | è‹¥åœ¨æ¨¡å—åŒ–ç¯å¢ƒï¼ˆESMï¼‰ä¸­ä½¿ç”¨ï¼Œä¼šæŠ¥æœªå®šä¹‰                                 | æ”¹ä¸º import { game, director, assetManager } from 'cc' |
| âš ï¸ åˆå§‹åŒ–åˆ†è¾¨ç‡ä½ç½®ç¨æ™š          | å»ºè®®åœ¨ run() å›è°ƒåç«‹å³æ‰§è¡Œ `cc.view.setDesignResolutionSize()` | ä½ å·²ç»åœ¨åšï¼Œä½†å¯ä»¥å°è£…æˆç‹¬ç«‹å‡½æ•°                                     |
| âœ… loadBaseAsset é€»è¾‘è‰¯å¥½   | åŠ è½½ internal + main                                    | å¯ä»¥ä¿ç•™                                                 |

---

## ğŸš€ ä¸‰ã€ä¼˜åŒ–åçš„è‡ªåŠ¨å¯åŠ¨ç‰ˆæœ¬ï¼ˆæ¨èï¼‰

```ts
import { game, assetManager, director, Scene, macro, view, color, Node } from 'cc'

export default class RenderEngine {
  private designResolutionSize: [number, number] = [1280, 720]
  cocosUrl = ''
  fpsControl: any = null

  async boot(canvasId: string, platform: Platform, cocosUrl: string) {
    this.cocosUrl = cocosUrl
    const isPreview = this.isLocalDev()

    // åˆå§‹åŒ–èµ„æºç®¡ç†å™¨
    if (isPreview) {
      assetManager.init({
        importBase: '/cocos-creator/assets/others/import',
        nativeBase: '/cocos-creator/assets/others/native',
      })
      console.log('[RenderEngine] æœ¬åœ°é¢„è§ˆæ¨¡å¼')
    } else {
      assetManager.init({})
      console.log('[RenderEngine] ç”Ÿäº§ç¯å¢ƒæ¨¡å¼ï¼ŒåŠ è½½ settings.json')
      await this.loadSettingsAndInit()
    }

    // åŠ è½½åŸºç¡€ bundle
    await Promise.all([
      this.loadBundle(`${cocosUrl}assets/internal`),
      this.loadBundle(`${cocosUrl}assets/main`),
    ])

    // å¯åŠ¨å¼•æ“
    await new Promise<void>((resolve) => {
      const options = {
        id: canvasId,
        frameRate: 60,
        scenes: [],
        renderMode: 2,
      }

      macro.ENABLE_WEBGL_ANTIALIAS = true
      game.run(options, () => {
        director.setClearColor(color(31, 30, 46))
        view.resizeWithBrowserSize(true)
        view.enableAntiAlias(true)
        view.enableRetina(true)
        view.setDesignResolutionSize(...this.designResolutionSize, 2)

        const scene = new Scene('EmptyScene')
        director.runSceneImmediate(scene)
        this.createFPSNode()
        resolve()
      })
    })
  }

  private async loadSettingsAndInit() {
    try {
      const res = await fetch(this.cocosUrl + 'settings.json')
      const settings = await res.json()
      ;(window as any)._CCSettings = settings
      console.log('[RenderEngine] settings.json åŠ è½½æˆåŠŸ')
    } catch (e) {
      console.warn('[RenderEngine] æ— æ³•åŠ è½½ settings.jsonï¼Œç»§ç»­è¿è¡Œ', e)
    }
  }

  private isLocalDev() {
    return (
      location.hostname === 'localhost' ||
      location.protocol === 'file:' ||
      location.hostname === '127.0.0.1'
    )
  }

  private async loadBundle(bundleUrl: string) {
    return new Promise((resolve, reject) => {
      assetManager.loadBundle(bundleUrl, (err, bundle) => {
        if (err) reject(err)
        else resolve(bundle)
      })
    })
  }

  private createFPSNode() {
    const node = new Node('FPSControl')
    const fpsCtrl = node.addComponent(FPSControl)
    fpsCtrl.reset(this.designResolutionSize)
    director.getScene()?.addChild(node)
    this.fpsControl = fpsCtrl
  }
}
```

---

## âœ… å››ã€è¿è¡Œæ–¹å¼å¯¹æ¯”

| ç¯å¢ƒ   | è‡ªåŠ¨æ£€æµ‹              | èµ„æºåŠ è½½                        | å¯åŠ¨æ–¹å¼                 |
| ---- | ----------------- | --------------------------- | -------------------- |
| æœ¬åœ°è°ƒè¯• | localhost / file: | è‡ªå®šä¹‰ importBase + nativeBase | æ‰‹åŠ¨åŠ è½½ bundle          |
| æ‰“åŒ…å  | settings.json å­˜åœ¨  | è‡ªåŠ¨åŠ è½½ settings.json          | `cc.game.run()` æ­£å¸¸å¯åŠ¨ |

---

## ğŸ’¡ äº”ã€æ€»ç»“ï¼šåŒºåˆ«åœ¨äºèµ„æºä¸é…ç½®åŠ è½½æ–¹å¼

| å·®å¼‚é¡¹                   | æœ¬åœ°å¯åŠ¨                        | æ‰“åŒ…å¯åŠ¨            |
| --------------------- | --------------------------- | --------------- |
| `settings.json`       | ä¸åŠ è½½                         | å¿…é¡»åŠ è½½            |
| `assetManager.init()` | æŒ‡å®šæœ¬åœ°è·¯å¾„                      | é»˜è®¤è·¯å¾„            |
| `èµ„æºè·¯å¾„`                | `/cocos-creator/assets/...` | ç›¸å¯¹è·¯å¾„ï¼ˆ`assets/`ï¼‰ |
| `åŠ è½½é¡ºåº`                | å†…éƒ¨é€»è¾‘å›ºå®š                      | è‡ªå®šä¹‰é€»è¾‘           |
| `è¿è¡Œå…¥å£`                | `game.run()` æ‰‹åŠ¨å¯åŠ¨           | `main.js` è‡ªåŠ¨è°ƒç”¨  |

---

æ˜¯å¦å¸Œæœ›æˆ‘å¸®ä½ æŠŠè¿™ç‰ˆæ”¹æˆå¯å…¼å®¹ **Cocos Creator 3.6+**ï¼ˆå³é‡‡ç”¨ `cclegacy` æ¨¡å¼ã€æ¨¡å—åŒ–å¯¼å…¥ï¼‰ï¼Œè¿™æ ·å¯ä»¥ç›´æ¥åœ¨ç°ä»£å‰ç«¯é¡¹ç›®ä¸­ä½¿ç”¨ï¼ˆæ¯”å¦‚ç”¨ Webpack/Vite åµŒå…¥ï¼‰ï¼Ÿ
