ä½ æä¾›çš„è¿™ä¸ª `docker-compose.yaml` æ–‡ä»¶å®šä¹‰äº†ä¸€ä¸ª **å¾®æœåŠ¡æ¶æ„åº”ç”¨çš„æœ¬åœ°å¼€å‘ç¯å¢ƒ**ï¼Œä½¿ç”¨ Docker Compose æ¥ä¸€æ¬¡æ€§å¯åŠ¨å¤šä¸ªæœåŠ¡ã€‚è¿™æ˜¯ä¸€ä¸ª**å…¸å‹çš„å…¨æ ˆé¡¹ç›®å¼€å‘/è°ƒè¯•ç”¨ç¯å¢ƒ**ã€‚

æˆ‘æ¥å¸®ä½ é€ä¸ªè§£é‡Šå®ƒçš„æ„ä¹‰å’Œç»“æ„ã€‚

---

## ğŸ§± æ•´ä½“ç»“æ„

```yaml
version: "3"  # Docker Compose æ–‡ä»¶ç‰ˆæœ¬ï¼Œä½¿ç”¨ v3ï¼ˆå¸¸ç”¨äº Docker Engine >=1.13ï¼‰
services:     # å®šä¹‰å¤šä¸ªæœåŠ¡ï¼ˆæ¯ä¸ªæœåŠ¡ä¼šå˜æˆä¸€ä¸ªå®¹å™¨ï¼‰
  frontend:         # å‰ç«¯æœåŠ¡
  auth-api:         # è®¤è¯ API
  todos-api:        # ä»£åŠäº‹é¡¹ API
  users-api:        # ç”¨æˆ·æœåŠ¡
  log-message-processor: # æ—¥å¿—å¤„ç†æœåŠ¡
  zipkin:           # åˆ†å¸ƒå¼é“¾è·¯è¿½è¸ªï¼ˆZipkinï¼‰
  redis-queue:      # Redis æ¶ˆæ¯é˜Ÿåˆ—
```

---

## ğŸ“¦ æœåŠ¡è¯¦è§£

### 1. `frontend`

å‰ç«¯é¡µé¢ï¼ˆå¯èƒ½æ˜¯ React/Vue/Angularï¼‰

```yaml
    build: ./frontend       # æ„å»ºé•œåƒæ‰€ç”¨çš„ Dockerfile åœ¨ frontend ç›®å½•
    image: frontend         # ç”Ÿæˆçš„é•œåƒå
    environment:
      PORT: 8080
      AUTH_API_ADDRESS: http://auth-api:8081
      TODOS_API_ADDRESS: http://todos-api:8082
      ZIPKIN_URL: http://zipkin:9411/api/v2/spans
    ports:
      - 8080:8080           # æœ¬æœº 8080 æ˜ å°„åˆ°å®¹å™¨ 8080
    depends_on:
      - zipkin
      - auth-api
      - todos-api
      - users-api
```

* å‰ç«¯é€šè¿‡ç¯å¢ƒå˜é‡è®¿é—®å„ä¸ªåç«¯ APIã€‚
* `depends_on` ç¡®ä¿ä¾èµ–æœåŠ¡ä¼˜å…ˆå¯åŠ¨ï¼ˆ**æ³¨æ„ï¼šä¸ä¼šä¿è¯æœåŠ¡å®Œå…¨å°±ç»ª**ï¼‰ã€‚

---

### 2. `auth-api`

è®¤è¯æœåŠ¡ï¼Œè´Ÿè´£ç™»å½•ã€æ³¨å†Œã€é‰´æƒç­‰ã€‚

```yaml
    build: ./auth-api
    environment:
      JWT_SECRET: myfancysecret
      USERS_API_ADDRESS: http://users-api:8083
```

* ä¼šè°ƒç”¨ `users-api`
* ä½¿ç”¨ JWT åšèº«ä»½éªŒè¯

---

### 3. `todos-api`

ä»£åŠäº‹é¡¹æœåŠ¡

```yaml
    build: ./todos-api
    environment:
      REDIS_HOST: redis-queue
      REDIS_CHANNEL: log_channel
```

* ä¼šå°†æ—¥å¿—å‘åˆ° Redis æ¶ˆæ¯é˜Ÿåˆ—
* æ”¯æŒé“¾è·¯è¿½è¸ªï¼ˆZipkinï¼‰

---

### 4. `users-api`

ç”¨æˆ·æœåŠ¡ï¼Œå¯èƒ½ç”¨çš„æ˜¯ Spring Bootï¼ˆä»ç¯å¢ƒå˜é‡åˆ¤æ–­ï¼‰

```yaml
    environment:
     SERVER_PORT: 8083
     SPRING_ZIPKIN_BASE_URL: http://zipkin:9411
```

---

### 5. `log-message-processor`

* è´Ÿè´£ä» Redis æ¶ˆæ¯é˜Ÿåˆ—ä¸­æ¶ˆè´¹æ—¥å¿—æ¶ˆæ¯
* ç”¨äºå¼‚æ­¥å¤„ç†æ—¥å¿—ï¼Œæ¯”å¦‚è®°å½•æ•°æ®åº“æˆ–å¤–éƒ¨å­˜å‚¨

---

### 6. `zipkin`

```yaml
    image: openzipkin/zipkin
    ports:
      - 9411:9411
```

* åˆ†å¸ƒå¼è¿½è¸ªç³»ç»Ÿï¼ŒæœåŠ¡ä¹‹é—´è°ƒç”¨é“¾æ¡å¯ä»¥å¯è§†åŒ–å±•ç¤ºã€‚
* å„æœåŠ¡é€šè¿‡ `ZIPKIN_URL` æŠŠè¿½è¸ªæ•°æ®å‘è¿‡æ¥

è®¿é—®åœ°å€ï¼š[http://localhost:9411](http://localhost:9411)

---

### 7. `redis-queue`

```yaml
    image: redis
```

* ç”¨ä½œæ¶ˆæ¯ä¸­é—´ä»¶ï¼Œæä¾›**å‘å¸ƒ/è®¢é˜…åŠŸèƒ½**
* `todos-api` å‘å¸ƒæ—¥å¿—åˆ° channel
* `log-message-processor` æ¶ˆè´¹æ—¥å¿—ä¿¡æ¯

---

## ğŸ”„ æœåŠ¡ä¹‹é—´çš„å…³ç³»å›¾

```text
        [frontend]
          /   \
         â†“     â†“
   [auth-api]  [todos-api] 
         â†“         â†“
    [users-api]   [redis-queue] â† [log-message-processor]
                         â†“
                      [zipkin]
```

---

## ğŸ§  æ€»ç»“ä¸€ä¸‹è¿™ä¸ª `docker-compose.yaml` çš„ä½œç”¨ï¼š

* ä¸€æ¬¡æ€§æ­å»ºå®Œæ•´çš„å¾®æœåŠ¡ç³»ç»Ÿç¯å¢ƒï¼ˆå‰åç«¯ã€æ¶ˆæ¯é˜Ÿåˆ—ã€é“¾è·¯è¿½è¸ªç­‰ï¼‰
* æ¨¡æ‹ŸçœŸå®çš„ç”Ÿäº§éƒ¨ç½²æµç¨‹
* å®ç°æœåŠ¡çš„è§£è€¦ & å¯è§†åŒ–è¿½è¸ª
* æé«˜å¼€å‘ & è”è°ƒæ•ˆç‡

---

## âœ… å¦‚ä½•ä½¿ç”¨è¿™ä¸ªæ–‡ä»¶ï¼Ÿ

1. å°†å„ä¸ªç›®å½•ä¸‹ï¼ˆå¦‚ `frontend/`, `auth-api/` ç­‰ï¼‰å†™å¥½ `Dockerfile`
2. åœ¨é¡¹ç›®æ ¹ç›®å½•è¿è¡Œï¼š

```bash
docker-compose up --build
```

3. æµè§ˆå™¨è®¿é—®ï¼š

   * å‰ç«¯é¡µé¢: [http://localhost:8080](http://localhost:8080)
   * Zipkin è·Ÿè¸ªé¡µé¢: [http://localhost:9411](http://localhost:9411)

